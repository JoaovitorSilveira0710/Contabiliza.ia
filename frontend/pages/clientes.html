<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Contabiliza.IA</title>
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="icon" href="/src/styles/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="/dist/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/src/styles/globals.css">
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Sidebar -->
    <div class="flex h-screen bg-gray-900">
        <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg flex items-center justify-center animate-pulse">
                        <i class="fas fa-calculator text-white"></i>
                    </div>
                    <span class="text-lg font-bold bg-gradient-to-r from-purple-400 to-indigo-400 bg-clip-text text-transparent">Contabiliza.IA</span>
                </div>
            </div>

            <nav class="p-4 space-y-2" id="sidebarNav">
                <a href="/pages/dashboard.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </a>
                <a href="/pages/clientes.html" class="flex items-center gap-3 px-4 py-3 bg-purple-600/20 text-purple-400 rounded-lg border border-purple-600/30">
                    <i class="fas fa-users w-5"></i> Clientes
                </a>
                <a href="/pages/notas-fiscais.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-file-invoice w-5"></i> Notas Fiscais
                </a>
                <a href="/pages/financeiro.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-chart-bar w-5"></i> Financeiro
                </a>
                <a href="/pages/juridico.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-scale-balanced w-5"></i> Jur√≠dico
                </a>
                <a href="/pages/relatorios.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-file-pdf w-5"></i> Relat√≥rios
                </a>
                <a href="/pages/estoque.html" class="flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all">
                    <i class="fas fa-boxes-stacked w-5"></i> Estoque
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
                <div class="flex justify-between items-center px-6 py-4">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold">Clientes</h1>
                        <button onclick="openClientModal()" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
                            <i class="fas fa-user-plus"></i> Novo Cliente
                        </button>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Data e Hora -->
                        <div class="flex items-center gap-2 text-sm text-gray-300">
                            <i class="fas fa-clock text-purple-400"></i>
                            <span id="currentDateTime"></span>
                        </div>
                        <!-- Filtros -->
                        <button onclick="toggleFilters()" class="p-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-all" title="Filtros">
                            <i class="fas fa-filter text-xl"></i>
                        </button>
                        <!-- Notifica√ß√µes -->
                        <button class="relative p-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-all" title="Notifica√ß√µes">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <!-- Configura√ß√µes (Master/Admin) -->
                        <a href="/pages/configuracoes.html" id="configButton" class="hidden p-2 text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-all" title="Configura√ß√µes">
                            <i class="fas fa-cog text-xl"></i>
                        </a>
                        <!-- Usu√°rio -->
                        <div class="flex items-center gap-3 pl-4 border-l border-gray-700">
                            <div class="text-right">
                                <p class="text-sm font-medium text-white" id="userName"></p>
                                <p class="text-xs text-gray-400" id="userEmail"></p>
                            </div>
                            <button onclick="logout()" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 text-sm transition-all">
                                <i class="fas fa-sign-out-alt mr-1"></i> Sair
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div id="filters" class="hidden px-6 py-4 bg-gray-700/50 border-t border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="searchInput" placeholder="Buscar por nome ou CNPJ..." class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-600">
                        <select id="statusFilter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-purple-600">
                            <option value="">Todos os Status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                        <input type="date" id="dateFilter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        <button onclick="applyFilters()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-all">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="p-6">
                <!-- React Table Root -->
                <div id="react-clientes-table-root"></div>

                <!-- Loading State (OLD - HIDDEN) -->
                <div id="loadingState" class="hidden text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                    <p class="text-gray-400">Carregando clientes...</p>
                </div>

                <!-- Clients Table (OLD - HIDDEN) -->
                <div id="clientsContainer" class="hidden glass-card rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-800/50 border-b border-gray-700">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Nome</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">CNPJ/CPF</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Email</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Status</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">Cadastro</th>
                                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-300">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>

                <!-- Empty State (OLD - HIDDEN) -->
                <div id="emptyState" class="hidden text-center py-12">
                    <i class="fas fa-inbox text-5xl text-gray-700 mb-4"></i>
                    <p class="text-gray-400 mb-4">Nenhum cliente encontrado</p>
                    <button onclick="openClientModal()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-all">
                        Criar Primeiro Cliente
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto glass-card">
            <!-- Cabe√ßalho removido conforme solicita√ß√£o (titulo e bot√£o X) -->
            <!-- Mantemos um elemento oculto apenas para evitar erros JS ao setar modalTitle -->
            <h2 id="modalTitle" class="hidden"></h2>

            <form id="clientForm" onsubmit="handleClientSubmit(event)">
                <!-- Dados B√°sicos -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-purple-400"><i class="fas fa-clipboard-list"></i> Dados B√°sicos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Tipo de Cadastro *</label>
                            <select id="entityType" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <option value="F">Pessoa F√≠sica</option>
                                <option value="J">Pessoa Jur√≠dica</option>
                                <option value="FAZENDA">Fazenda</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Nome/Raz√£o Social *</label>
                            <input type="text" id="clientName" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" id="docLabel">CNPJ/CPF *</label>
                            <input type="text" id="clientCnpj" required placeholder="00.000.000/0000-00" onblur="buscarCnpjEmpresa()" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div data-group="pj">
                            <label class="block text-sm font-medium mb-2">Nome Fantasia</label>
                            <input type="text" id="clientTradeName" placeholder="Nome Fantasia" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Email *</label>
                            <input type="email" id="clientEmail" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Telefone</label>
                            <input type="tel" id="clientPhone" placeholder="(00) 00000-0000" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Celular</label>
                            <input type="tel" id="clientMobile" placeholder="(00) 00000-0000" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Tipo Pessoa *</label>
                            <select id="clientTipoPessoa" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <option value="J">Jur√≠dica</option>
                                <option value="F">F√≠sica</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select id="clientStatus" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                        <div data-group="pj">
                            <label class="block text-sm font-medium mb-2">Inscri√ß√£o Estadual</label>
                            <input type="text" id="clientStateReg" placeholder="IE" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div data-group="pj">
                            <label class="block text-sm font-medium mb-2">Inscri√ß√£o Municipal</label>
                            <input type="text" id="clientMunicipalReg" placeholder="IM" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-purple-400">üìç Endere√ßo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">CEP</label>
                            <div class="relative">
                                <input type="text" id="clientCep" placeholder="00000-000" maxlength="9" oninput="formatCep(this)" onblur="buscarCep()" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <i id="cepLoader" class="fas fa-spinner fa-spin absolute right-3 top-3 text-purple-600 hidden"></i>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Logradouro</label>
                            <input type="text" id="clientLogradouro" placeholder="Rua, Avenida..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">N√∫mero</label>
                            <input type="text" id="clientNumero" placeholder="123" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Complemento</label>
                            <input type="text" id="clientComplemento" placeholder="Apto, Sala..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Bairro</label>
                            <input type="text" id="clientBairro" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Cidade</label>
                            <input type="text" id="clientCidade" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">UF</label>
                            <select id="clientUf" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <option value="">Selecione</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="PR">Paran√°</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="BA">Bahia</option>
                                <option value="PE">Pernambuco</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="AM">Amazonas</option>
                                <option value="PA">Par√°</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Fazenda -->
                <div class="mb-4 hidden" data-group="farm">
                    <h3 class="text-lg font-semibold mb-3 text-purple-400">üèûÔ∏è Dados da Fazenda</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nome da Fazenda *</label>
                            <input type="text" id="farmName" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Ex.: Fazenda Santa Rita">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">√Årea (hectares)</label>
                            <input type="number" id="farmAreaHa" step="0.01" min="0" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Ex.: 120.50">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Donos (CPF, separado por v√≠rgula)</label>
                            <input type="text" id="farmOwnersCpfs" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Ex.: 123.456.789-01, 987.654.321-00">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Matr√≠cula</label>
                            <input type="text" id="farmMatricula" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="N¬∫ da matr√≠cula">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">CAR</label>
                            <input type="text" id="farmCAR" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="Registro CAR">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">ITR</label>
                            <input type="text" id="farmITR" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="ITR">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">CCIR</label>
                            <input type="text" id="farmCCIR" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="CCIR">
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Ao salvar, adicionaremos uma observa√ß√£o autom√°tica no cadastro dos donos com os dados da fazenda.</p>
                </div>

                <!-- Configura√ß√µes Fiscais e Observa√ß√µes -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-purple-400">üßæ Configura√ß√µes Fiscais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Atividade</label>
                            <input type="text" id="clientActivity" placeholder="Descreva a atividade principal" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Regime Tribut√°rio</label>
                            <select id="clientTaxRegime" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                                <option value="">Selecione</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                                <option value="Pessoa F√≠sica">Pessoa F√≠sica</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Prazo de Pagamento (dias)</label>
                            <input type="number" id="clientPaymentTerms" min="0" step="1" placeholder="30" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Limite de Cr√©dito</label>
                            <input type="number" id="clientCreditLimit" min="0" step="0.01" placeholder="0.00" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Observa√ß√µes</label>
                            <textarea id="clientNotes" rows="3" placeholder="Anota√ß√µes gerais" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-600"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t border-gray-700">
                    <button type="button" onclick="closeClientModal()" class="px-6 py-2 border border-gray-600 rounded-lg hover:bg-gray-700 transition-all">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg hover:shadow-lg transition-all">
                        Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/src/js/config.js?v=20251124"></script>
    <script src="/src/js/api-service.js?v=20251124"></script>
    <script>
        let clients = [];
        let filteredClients = [];

        // Formatar CEP automaticamente
        function formatCep(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            input.value = value;
        }

        // Buscar CEP na API ViaCEP
        async function buscarCep() {
            const cepInput = document.getElementById('clientCep');
            const cep = cepInput.value.replace(/\D/g, '');
            
            // Validar CEP (8 d√≠gitos)
            if (cep.length !== 8) {
                return;
            }

            const loader = document.getElementById('cepLoader');
            loader.classList.remove('hidden');

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    showToast('CEP n√£o encontrado', 'error');
                    loader.classList.add('hidden');
                    return;
                }

                // Preencher campos automaticamente
                document.getElementById('clientLogradouro').value = data.logradouro || '';
                document.getElementById('clientBairro').value = data.bairro || '';
                document.getElementById('clientCidade').value = data.localidade || '';
                document.getElementById('clientUf').value = data.uf || '';

                // Focar no campo n√∫mero
                document.getElementById('clientNumero').focus();
                
                showToast('Endere√ßo encontrado!', 'success');
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                showToast('Erro ao buscar CEP. Tente novamente.', 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Buscar CNPJ (BrasilAPI) e preencher automaticamente quando for PJ
        async function buscarCnpjEmpresa() {
            const tipo = document.getElementById('entityType').value;
            if (tipo !== 'J') return;
            const input = document.getElementById('clientCnpj');
            const cnpj = (input.value || '').replace(/\D/g, '');
            if (cnpj.length !== 14) return;
            try {
                const data = await apiService.request('/utils/cnpj/' + cnpj + '/', { method: 'GET' });
                // Preencher campos
                document.getElementById('clientName').value = data.name || '';
                document.getElementById('clientTradeName').value = data.trade_name || '';
                document.getElementById('clientEmail').value = data.email || '';
                document.getElementById('clientPhone').value = data.phone || '';
                document.getElementById('clientCep').value = data.zip_code || '';
                document.getElementById('clientLogradouro').value = data.street || '';
                document.getElementById('clientNumero').value = data.number || '';
                document.getElementById('clientComplemento').value = data.complement || '';
                document.getElementById('clientBairro').value = data.neighborhood || '';
                document.getElementById('clientCidade').value = data.city || '';
                document.getElementById('clientUf').value = data.state || '';
                showToast('Dados da empresa preenchidos automaticamente.', 'success');
            } catch (e) {
                console.error('Erro ao buscar CNPJ:', e);
                showToast('N√£o foi poss√≠vel consultar o CNPJ.', 'error');
            }
        }

        // M√°scaras de entrada para CPF/CNPJ/Telefone
        function maskCPF(value) {
            const v = value.replace(/\D/g, '').slice(0, 11);
            if (v.length <= 3) return v;
            if (v.length <= 6) return `${v.slice(0,3)}.${v.slice(3)}`;
            if (v.length <= 9) return `${v.slice(0,3)}.${v.slice(3,6)}.${v.slice(6)}`;
            return `${v.slice(0,3)}.${v.slice(3,6)}.${v.slice(6,9)}-${v.slice(9,11)}`;
        }

        function maskCNPJ(value) {
            const v = value.replace(/\D/g, '').slice(0, 14);
            if (v.length <= 2) return v;
            if (v.length <= 5) return `${v.slice(0,2)}.${v.slice(2)}`;
            if (v.length <= 8) return `${v.slice(0,2)}.${v.slice(2,5)}.${v.slice(5)}`;
            if (v.length <= 12) return `${v.slice(0,2)}.${v.slice(2,5)}.${v.slice(5,8)}/${v.slice(8)}`;
            return `${v.slice(0,2)}.${v.slice(2,5)}.${v.slice(5,8)}/${v.slice(8,12)}-${v.slice(12,14)}`;
        }

        function maskPhone(value) {
            const v = value.replace(/\D/g, '').slice(0, 11);
            if (v.length <= 2) return v;
            if (v.length <= 7) return `(${v.slice(0,2)}) ${v.slice(2)}`;
            if (v.length === 10) return `(${v.slice(0,2)}) ${v.slice(2,6)}-${v.slice(6,10)}`;
            return `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7,11)}`;
        }

        function applyMasks() {
            const entityType = document.getElementById('entityType').value;
            const docInput = document.getElementById('clientCnpj');
            if (docInput) {
                docInput.addEventListener('input', () => {
                    let raw = docInput.value || '';
                    const digits = raw.replace(/\D/g, '');

                    // Auto-ajuste do tipo: se passar de 11 d√≠gitos, considerar PJ
                    const typeSelect = document.getElementById('entityType');
                    if (digits.length > 11 && typeSelect && typeSelect.value !== 'J') {
                        typeSelect.value = 'J';
                        applyPersonTypeVisibility();
                    } else if (digits.length <= 11 && typeSelect && typeSelect.value !== 'F') {
                        // Se reduzir para 11 ou menos, considerar PF
                        typeSelect.value = 'F';
                        applyPersonTypeVisibility();
                    }

                    const currentType = document.getElementById('entityType').value;
                    docInput.value = (currentType === 'J') ? maskCNPJ(raw) : maskCPF(raw);
                    // Disparar consulta de CNPJ ao completar 14 d√≠gitos
                    if (currentType === 'J' && digits.length === 14) {
                        buscarCnpjEmpresa();
                    }
                });
            }

            const phoneInput = document.getElementById('clientPhone');
            const mobileInput = document.getElementById('clientMobile');
            if (phoneInput) phoneInput.addEventListener('input', () => { phoneInput.value = maskPhone(phoneInput.value || ''); });
            if (mobileInput) mobileInput.addEventListener('input', () => { mobileInput.value = maskPhone(mobileInput.value || ''); });

            const ownersInput = document.getElementById('farmOwnersCpfs');
            if (ownersInput) {
                ownersInput.addEventListener('blur', () => {
                    const parts = ownersInput.value.split(',').map(s => s.trim()).filter(Boolean);
                    ownersInput.value = parts.map(p => maskCPF(p)).join(', ');
                });
            }
        }

        window.addEventListener('DOMContentLoaded', applyMasks);
        document.getElementById('entityType').addEventListener('change', applyMasks);

        // Load clients on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadClients();
            feather.replace();
        });

        // DESABILITADO - Usando React agora
        async function loadClients() {
            // Fun√ß√£o antiga desabilitada - React carrega os clientes automaticamente
            return;
            /*
            const loadingState = document.getElementById('loadingState');
            const clientsContainer = document.getElementById('clientsContainer');
            const emptyState = document.getElementById('emptyState');

            try {
                const data = await apiService.getClientes();
                clients = Array.isArray(data) ? data : (data?.results || []);
                filteredClients = clients;
                
                if (clients.length === 0) {
                    loadingState.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                } else {
                    loadingState.classList.add('hidden');
                    renderClientsTable();
                    clientsContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                loadingState.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-circle text-4xl text-red-600 mb-4"></i>
                        <p class="text-gray-400">Erro ao carregar clientes</p>
                        <p class="text-gray-500 text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
            */
        }

        function renderClientsTable() {
            const tableBody = document.getElementById('clientsTableBody');
            
            tableBody.innerHTML = filteredClients.map(client => `
                <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-all">
                    <td class="px-6 py-4 font-medium">${client.name || client.nome_razao_social || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-400">${client.tax_id || client.cnpj_cpf || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-400">${client.email || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                            (client.status === 'active' || client.ativo)
                            ? 'bg-green-600/20 text-green-400 border border-green-600/30' 
                            : 'bg-gray-600/20 text-gray-400 border border-gray-600/30'
                        }">
                            ${(client.status === 'active' || client.ativo) ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-400">${client.created_at ? new Date(client.created_at).toLocaleDateString('pt-BR') : (client.data_cadastro ? new Date(client.data_cadastro).toLocaleDateString('pt-BR') : 'N/A')}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editClient(${client.id})" class="text-blue-400 hover:text-blue-300 mr-3" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteClient(${client.id})" class="text-red-400 hover:text-red-300" title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleFilters() {
            document.getElementById('filters').classList.toggle('hidden');
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const date = document.getElementById('dateFilter').value;

            filteredClients = clients.filter(client => {
                const matchesSearch = !search || 
                    client.nome_razao_social.toLowerCase().includes(search) ||
                    (client.cnpj_cpf && client.cnpj_cpf.includes(search)) ||
                    (client.cpf && client.cpf.includes(search));
                
                const matchesStatus = !status || (status === 'ativo' ? client.ativo : !client.ativo);
                
                return matchesSearch && matchesStatus;
            });

            renderClientsTable();
        }

        function openClientModal() {
            document.getElementById('clientModal').classList.remove('hidden');
            const titleEl = document.getElementById('modalTitle');
            if (titleEl) titleEl.textContent = '';
            document.getElementById('clientForm').reset();
            document.getElementById('clientForm').onsubmit = handleClientSubmit;
            applyPersonTypeVisibility();
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.add('hidden');
        }

        async function handleClientSubmit(event) {
            event.preventDefault();

            const entityType = document.getElementById('entityType').value; // 'F', 'J', 'FAZENDA'

            // Fluxo especial: Fazenda
            if (entityType === 'FAZENDA') {
                const farmName = document.getElementById('farmName').value.trim();
                const farmAreaHa = document.getElementById('farmAreaHa').value.trim();
                const ownersRaw = document.getElementById('farmOwnersCpfs').value.trim();
                const ownersCpfs = ownersRaw.split(',').map(s => s.replace(/\D/g, '')).filter(s => s.length === 11);
                const matricula = document.getElementById('farmMatricula').value.trim();
                const car = document.getElementById('farmCAR').value.trim();
                const itr = document.getElementById('farmITR').value.trim();
                const ccir = document.getElementById('farmCCIR').value.trim();

                const city = document.getElementById('clientCidade').value.trim();
                const state = document.getElementById('clientUf').value.trim();

                if (!farmName || ownersCpfs.length === 0) {
                    showToast('Informe o nome da fazenda e ao menos um CPF de dono.', 'error');
                    return;
                }

                // Criar fazenda via API e vincular donos por CPF
                try {
                    await apiService.request(`${CONFIG.ENDPOINTS.CLIENTES.replace('/clients', '')}/farms/`, {
                        method: 'POST',
                        body: {
                            name: farmName,
                            area_ha: farmAreaHa ? parseFloat(farmAreaHa) : null,
                            city,
                            state,
                            matricula: matricula || null,
                            car: car || null,
                            itr: itr || null,
                            ccir: ccir || null,
                            owners_cpfs: ownersCpfs
                        }
                    });
                } catch (e) {
                    showToast('Erro ao criar fazenda: ' + (e.message || 'Verifique os dados'), 'error');
                    return;
                }

                showToast('Fazenda criada e vinculada aos donos.', 'success');
                closeClientModal();
                await loadClients();
                return;
            }

            const cnpjCpf = document.getElementById('clientCnpj').value.replace(/\D/g, '');
            const tipoPessoa = cnpjCpf.length === 11 ? 'PF' : 'PJ'; // Mapear para modelo (PF/PJ)

            const clientData = {
                // Campos conforme serializers.ClientSerializer
                person_type: tipoPessoa,
                name: document.getElementById('clientName').value,
                trade_name: document.getElementById('clientTradeName').value,
                tax_id: cnpjCpf,
                state_registration: document.getElementById('clientStateReg').value,
                municipal_registration: document.getElementById('clientMunicipalReg').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value.replace(/\D/g, ''),
                mobile: document.getElementById('clientMobile').value.replace(/\D/g, ''),
                zip_code: document.getElementById('clientCep').value.replace(/\D/g, ''),
                street: document.getElementById('clientLogradouro').value,
                number: document.getElementById('clientNumero').value,
                complement: document.getElementById('clientComplemento').value,
                neighborhood: document.getElementById('clientBairro').value,
                city: document.getElementById('clientCidade').value,
                state: document.getElementById('clientUf').value,
                activity: document.getElementById('clientActivity')?.value || '',
                status: document.getElementById('clientStatus').value === 'true' ? 'active' : 'inactive',
                tax_regime: document.getElementById('clientTaxRegime')?.value || '',
                payment_terms: parseInt(document.getElementById('clientPaymentTerms')?.value || '30', 10),
                credit_limit: parseFloat(document.getElementById('clientCreditLimit')?.value || '0'),
                notes: document.getElementById('clientNotes')?.value || ''
            };

            try {
                await apiService.criarCliente(clientData);
                closeClientModal();
                await loadClients();
                showToast('Cliente criado com sucesso!', 'success');
            } catch (error) {
                showToast('Erro ao criar cliente: ' + error.message, 'error');
            }
        }

        async function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const titleEl = document.getElementById('modalTitle');
            if (titleEl) titleEl.textContent = ''; // permanece oculto
            document.getElementById('clientName').value = client.name || '';
            document.getElementById('clientCnpj').value = client.tax_id || '';
            document.getElementById('clientTradeName').value = client.trade_name || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientMobile').value = client.mobile || '';
            document.getElementById('clientTipoPessoa').value = client.person_type === 'PF' ? 'F' : 'J';
            document.getElementById('clientStatus').value = client.status === 'active' ? 'true' : 'false';
            document.getElementById('clientStateReg').value = client.state_registration || '';
            document.getElementById('clientMunicipalReg').value = client.municipal_registration || '';
            applyPersonTypeVisibility();
            
            // Preencher endere√ßo
            document.getElementById('clientCep').value = client.zip_code || '';
            document.getElementById('clientLogradouro').value = client.street || '';
            document.getElementById('clientNumero').value = client.number || '';
            document.getElementById('clientComplemento').value = client.complement || '';
            document.getElementById('clientBairro').value = client.neighborhood || '';
            document.getElementById('clientCidade').value = client.city || '';
            document.getElementById('clientUf').value = client.state || '';

            document.getElementById('clientForm').onsubmit = async (event) => {
                event.preventDefault();
                
                const cnpjCpf = document.getElementById('clientCnpj').value.replace(/\D/g, '');
                
                // Valida√ß√£o b√°sica do CPF/CNPJ
                if (![11, 14].includes(cnpjCpf.length)) {
                    showToast('CPF deve ter 11 d√≠gitos ou CNPJ 14 d√≠gitos', 'error');
                    return;
                }

                // Montar objeto completo a partir do formul√°rio
                const fullData = {
                    person_type: cnpjCpf.length === 11 ? 'PF' : 'PJ',
                    name: document.getElementById('clientName').value,
                    trade_name: document.getElementById('clientTradeName').value,
                    tax_id: cnpjCpf,
                    email: document.getElementById('clientEmail').value,
                    phone: document.getElementById('clientPhone').value.replace(/\D/g, ''),
                    mobile: document.getElementById('clientMobile').value.replace(/\D/g, ''),
                    state_registration: document.getElementById('clientStateReg').value,
                    municipal_registration: document.getElementById('clientMunicipalReg').value,
                    status: document.getElementById('clientStatus').value === 'true' ? 'active' : 'inactive',
                    zip_code: document.getElementById('clientCep').value.replace(/\D/g, ''),
                    street: document.getElementById('clientLogradouro').value,
                    number: document.getElementById('clientNumero').value,
                    complement: document.getElementById('clientComplemento').value,
                    neighborhood: document.getElementById('clientBairro').value,
                    city: document.getElementById('clientCidade').value,
                    state: document.getElementById('clientUf').value,
                    activity: document.getElementById('clientActivity')?.value || '',
                    tax_regime: document.getElementById('clientTaxRegime')?.value || '',
                    payment_terms: parseInt(document.getElementById('clientPaymentTerms')?.value || '30', 10),
                    credit_limit: parseFloat(document.getElementById('clientCreditLimit')?.value || '0'),
                    notes: document.getElementById('clientNotes')?.value || ''
                };

                // Enviar apenas campos alterados (PATCH incremental)
                const updateData = {};
                Object.keys(fullData).forEach((key) => {
                    const newVal = fullData[key];
                    const oldVal = client[key] ?? '';
                    // Normalizar para compara√ß√£o
                    const normNew = typeof newVal === 'string' ? newVal.trim() : newVal;
                    const normOld = typeof oldVal === 'string' ? oldVal.trim() : oldVal;
                    if (normNew !== normOld) {
                        updateData[key] = newVal;
                    }
                });

                // Se nada mudou, evitar requisi√ß√£o
                if (Object.keys(updateData).length === 0) {
                    showToast('Nenhuma altera√ß√£o detectada.', 'success');
                    return;
                }

                try {
                    await apiService.atualizarCliente(clientId, updateData);
                    closeClientModal();
                    await loadClients();
                    showToast('Cliente atualizado com sucesso!', 'success');
                } catch (error) {
                    showToast('Erro ao atualizar cliente: ' + (error.message || 'Verifique os campos'), 'error');
                }
            };

            document.getElementById('clientModal').classList.remove('hidden');
        }

        async function deleteClient(clientId) {
            try {
                await apiService.excluirCliente(clientId);
                await loadClients();
                showToast('Cliente deletado com sucesso!', 'success');
            } catch (error) {
                showToast('Erro ao deletar cliente: ' + error.message, 'error');
            }
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
        }

        // Atualizar data e hora em tempo real
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('pt-BR', options);
        }
        updateDateTime();
        setInterval(updateDateTime, 60000); // Atualizar a cada minuto

        // Mostrar bot√£o de configura√ß√µes para Master e Admin
        (function showConfigButton() {
            const userRole = localStorage.getItem('USER_ROLE');
            const userEmail = localStorage.getItem('USER_EMAIL');
            const userName = localStorage.getItem('USER_NAME') || userEmail?.split('@')[0] || 'Usu√°rio';
            
            // Preencher dados do usu√°rio
            if (document.getElementById('userName')) {
                document.getElementById('userName').textContent = userName;
            }
            if (document.getElementById('userEmail')) {
                document.getElementById('userEmail').textContent = userEmail || '';
            }
            
            // Mostrar bot√£o de configura√ß√µes
            if (userRole === 'master' || userRole === 'admin') {
                const configBtn = document.getElementById('configButton');
                if (configBtn) configBtn.classList.remove('hidden');
            }
        })();

        // Adicionar link de Configura√ß√µes para Master e Admin
        (function addConfigLink() {
            const userRole = localStorage.getItem('USER_ROLE');
            const nav = document.getElementById('sidebarNav');
            if (nav && (userRole === 'master' || userRole === 'admin')) {
                const link = document.createElement('a');
                link.href = '/pages/configuracoes.html';
                link.className = 'flex items-center gap-3 px-4 py-3 text-gray-300 hover:bg-gray-700 rounded-lg transition-all';
                link.innerHTML = '<i class="fas fa-cog w-5"></i> Configura√ß√µes';
                nav.appendChild(link);
            }
        })();

        // Alternar campos por tipo de pessoa
        function applyPersonTypeVisibility() {
            const tipoPessoa = document.getElementById('clientTipoPessoa').value; // 'J' ou 'F'
            const entityType = document.getElementById('entityType').value; // 'J', 'F', 'FAZENDA'
            const isPJ = (entityType === 'J');
            const pjFields = document.querySelectorAll('[data-group="pj"]');
            pjFields.forEach(el => {
                el.classList.toggle('hidden', !isPJ);
            });
            const farmFields = document.querySelectorAll('[data-group="farm"]');
            farmFields.forEach(el => {
                el.classList.toggle('hidden', entityType !== 'FAZENDA');
            });

            const docLabel = document.getElementById('docLabel');
            const cnpjInput = document.getElementById('clientCnpj');
            if (entityType === 'J') {
                docLabel.textContent = 'CNPJ *';
                cnpjInput.placeholder = '00.000.000/0000-00';
            } else if (entityType === 'F') {
                docLabel.textContent = 'CPF *';
                cnpjInput.placeholder = '000.000.000-00';
            } else {
                docLabel.textContent = 'Documento (CPF/CNPJ)';
                cnpjInput.placeholder = 'Digite o documento se aplic√°vel';
            }
        }

        document.getElementById('clientTipoPessoa').addEventListener('change', applyPersonTypeVisibility);
        document.getElementById('entityType').addEventListener('change', applyPersonTypeVisibility);
    </script>

    <!-- React via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- App React -->
    <script src="/src/js/react-app.js?v=20251202020000"></script>
</body>
</html>
