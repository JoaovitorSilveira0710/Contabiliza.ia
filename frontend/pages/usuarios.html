<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gest√£o de Usu√°rios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/src/styles/globals.css">
</head>
<body class="bg-gray-900 text-white">
  <div class="max-w-3xl mx-auto p-8">
    <h1 class="text-3xl font-bold mb-6">üë§ Gest√£o de Usu√°rios</h1>

    <div class="glass-card p-6 rounded-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">Criar Usu√°rio Admin (somente Master)</h2>
      <form id="formUsuario" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Nome</label>
          <input id="nome" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="email" type="email" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="senha" type="password" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700" required />
          <div class="mt-2 flex items-center gap-3">
            <div class="w-full bg-gray-800 h-2 rounded">
              <div id="strengthBar" class="h-2 rounded bg-red-600" style="width: 0%"></div>
            </div>
            <span id="strengthLabel" class="text-sm text-gray-300">For√ßa: ‚Äî</span>
          </div>
          <ul class="text-xs text-gray-400 mt-2 list-disc pl-5">
            <li>M√≠nimo 12 caracteres</li>
            <li>Inclua mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos</li>
            <li>Evite usar o pr√≥prio email, sequ√™ncias (1234), ou palavras comuns</li>
          </ul>
        </div>
        <input type="hidden" id="tipo" value="admin" />
        <button id="submitBtn" class="px-4 py-2 bg-purple-600 rounded hover:bg-purple-700 disabled:opacity-60" disabled>Criar Admin</button>
      </form>
      <p id="msg" class="text-sm mt-3"></p>
    </div>

    <div class="glass-card p-6 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Usu√°rios Existentes</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="py-2">Nome</th>
            <th class="py-2">Email</th>
            <th class="py-2">Tipo</th>
            <th class="py-2">Status</th>
          </tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
      </table>
    </div>
  </div>

  <script src="/src/js/config.js"></script>
  <script>
    // Exige que o usu√°rio logado seja Master ou Admin para acessar esta p√°gina
    (function guardAdminOrMaster(){
      let email = localStorage.getItem('USER_EMAIL');
      let role = localStorage.getItem('USER_ROLE');
      // Compatibilidade legada com MASTER_EMAIL
      const legacyMaster = localStorage.getItem('MASTER_EMAIL');
      if ((!email || !role) && legacyMaster) {
        email = legacyMaster;
        role = 'master';
        localStorage.setItem('USER_EMAIL', email);
        localStorage.setItem('USER_ROLE', role);
      }
      if (!email || !role) {
        window.location.href = '/pages/login.html';
        return;
      }
      if (role !== 'master' && role !== 'admin') {
        alert('Acesso restrito: apenas Master e Admin podem acessar.');
        window.location.href = '/index.html';
        return;
      }
      // Se for Admin, ocultar/indicar restri√ß√£o do formul√°rio de cria√ß√£o de Admin
      if (role === 'admin') {
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('msg');
        const tipo = document.getElementById('tipo');
        // Bloqueia cria√ß√£o de Admin por Admin
        if (tipo) tipo.value = 'admin';
        if (btn) {
          btn.disabled = true;
          btn.classList.add('opacity-60');
        }
        if (msg) {
          msg.textContent = 'üîí Somente Master pode criar usu√°rios Admin. Voc√™ pode apenas visualizar a lista.';
        }
      }
    })();

    function avaliarSenha(email, senha) {
      let score = 0;
      const lower = /[a-z]/.test(senha);
      const upper = /[A-Z]/.test(senha);
      const digit = /\d/.test(senha);
      const symbol = /[^\w\s]/.test(senha);
      const length = senha.length;
      const common = /(password|senha|qwerty|1234|admin)/i.test(senha);
      const includesEmail = email && senha.toLowerCase().includes(email.toLowerCase());
      const repeated = /(.)\1{2,}/.test(senha);

      // Base score by length
      if (length >= 12) score += 40; else if (length >= 10) score += 25; else if (length >= 8) score += 15;
      // Character classes
      score += lower ? 10 : 0;
      score += upper ? 15 : 0;
      score += digit ? 10 : 0;
      score += symbol ? 15 : 0;
      // Penalties
      if (common) score -= 25;
      if (includesEmail) score -= 30;
      if (repeated) score -= 10;

      score = Math.max(0, Math.min(100, score));

      let label = 'Fraca';
      let color = '#dc2626'; // red-600
      if (score >= 80) { label = 'Forte'; color = '#16a34a'; } // green-600
      else if (score >= 60) { label = 'Boa'; color = '#f59e0b'; } // amber-500
      else if (score >= 40) { label = 'M√©dia'; color = '#f97316'; } // orange-500

      return { score, label, color };
    }

    function atualizarForcaSenha() {
      const email = document.getElementById('email').value;
      const senha = document.getElementById('senha').value;
      const { score, label, color } = avaliarSenha(email, senha);
      const bar = document.getElementById('strengthBar');
      const lbl = document.getElementById('strengthLabel');
      const btn = document.getElementById('submitBtn');
      bar.style.width = score + '%';
      bar.style.backgroundColor = color;
      lbl.textContent = `For√ßa: ${label}`;
      // Exigir "Forte" (>=80) para habilitar cria√ß√£o
      btn.disabled = !(score >= 80);
    }

    document.getElementById('email').addEventListener('input', atualizarForcaSenha);
    document.getElementById('senha').addEventListener('input', atualizarForcaSenha);

    async function fetchUsuarios() {
      const [resUsers, resOnline] = await Promise.all([
        fetch(`${CONFIG.API_BASE}/usuarios/`),
        fetch(`${CONFIG.API_BASE.replace('/api','')}/api/monitoramento/usuarios-online`)
      ]);
      const data = await resUsers.json();
      const online = await resOnline.json();
      const onlineEmails = new Set((online.usuarios_online || []).map(u => u.email));
      const tbody = document.getElementById('listaUsuarios');
      tbody.innerHTML = data.map(u => `
        <tr class="border-b border-gray-800">
          <td class="py-2">${u.nome}</td>
          <td class="py-2">${u.email}</td>
          <td class="py-2">${u.tipo}</td>
          <td class="py-2">
            ${onlineEmails.has(u.email) 
              ? '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-600/20 text-green-400">Online</span>' 
              : '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-600/20 text-gray-400">Offline</span>'}
          </td>
        </tr>
      `).join('');
    }

    document.getElementById('formUsuario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        nome: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        senha: document.getElementById('senha').value,
        tipo: document.getElementById('tipo').value,
      };
      try {
        const res = await fetch(`${CONFIG.API_BASE}/usuarios/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Cabe√ßalho de identidade - deve ser do Master
            'x-user-email': localStorage.getItem('MASTER_EMAIL') || 'master@contabiliza.ia'
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Erro');
        document.getElementById('msg').textContent = '‚úÖ Usu√°rio admin criado';
        document.getElementById('formUsuario').reset();
        atualizarForcaSenha();
        fetchUsuarios();
      } catch (err) {
        document.getElementById('msg').textContent = '‚ùå ' + err.message;
      }
    });

    fetchUsuarios();
    // Atualizar status online a cada 30 segundos
    setInterval(fetchUsuarios, 30000);
  </script>
</body>
</html>
